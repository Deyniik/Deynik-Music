<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Deynik Music</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <header class="top-nav">
        <div class="logo-area" onclick="location.hash='#home'">
            <h1>Deynik Music</h1>
            <svg class="logo-svg" width="34" height="34" viewBox="0 0 100 100">
                <polygon points="12,12 75,50 12,88" fill="#CC6B26" rx="8" ry="8" style="rx:8; ry:8"/>
                <path d="M65,30 Q88,50 65,70 M78,15 Q110,50 78,85" stroke="#CC6B26" fill="none" stroke-width="8" stroke-linecap="round" transform="translate(-5, 0)"/>
            </svg>
        </div>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Поиск треков или исполнителей">
        </div>
        <div style="width: 380px;"></div>
    </header>

    <div class="app-main">
        <aside class="panel side">
            <div class="filter-nav">
                <button class="nav-arrow" onclick="scrollFilters(-120)"><i data-lucide="chevron-left" size="18"></i></button>
                <div class="filter-scroll scroll-hide" id="filterScroll">
                    <button class="tab active" onclick="filterSide('all', this)"><i data-lucide="home" size="16"></i></button>
                    <button class="tab" onclick="filterSide('artist', this)">Исполнители</button>
                    <button class="tab" onclick="filterSide('album', this)">Альбомы</button>
                    <button class="tab" onclick="filterSide('playlist', this)">Плейлисты</button>
                    <button class="tab" onclick="filterSide('radio', this)">Радио</button>
                </div>
                <button class="nav-arrow" onclick="scrollFilters(120)"><i data-lucide="chevron-right" size="18"></i></button>
            </div>
            <div id="side-list" class="scroll-hide" style="overflow-y: auto;">
                <div class="side-item">
                    <div style="width:52px; height:52px; border-radius:6px; background: linear-gradient(135deg, #450af5, #c4efd9); display:flex; align-items:center; justify-content:center;">
                        <i data-lucide="heart" fill="white" color="white" size="24"></i>
                    </div>
                    <div style="margin-left:8px;"><b>Любимые треки</b><br><small style="color:#7a7a7a;">Плейлист • 0 треков</small></div>
                </div>
                <div id="filtered-content"></div>
                <div id="pinned-side-container" style="margin-top: 20px;"></div>
            </div>
        </aside>

        <main class="panel center scroll-hide" id="content-area"></main>

        <aside class="panel side">
            <img id="side-cover" src="" style="width:100%; border-radius:10px; margin-bottom:20px; display: none;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2 id="side-title" style="font-size:24px; font-weight:800;">Выберите трек</h2>
                    <p id="side-artist" style="color:#7a7a7a; font-size:17px;"></p>
                </div>
                <i data-lucide="heart" id="like-side" class="like-btn" onclick="toggleLike()"></i>
            </div>
            <div style="margin-top:35px; display: flex; flex-direction: column; flex: 1; min-height: 0;">
                <p style="font-weight:700; margin-bottom:12px; font-size:12px; color:#7a7a7a; text-transform:uppercase;">Очередь</p>
                <div id="queue-list" class="scroll-hide" style="overflow-y: auto; flex: 1;"></div>
            </div>
        </aside>
    </div>

    <footer class="player-bar">
        <div style="display:flex; align-items:center; gap:15px;">
            <img id="p-img" src="" style="width:58px; height:58px; border-radius:4px; background:#1a1a1a; display:none;">
            <div>
                <b id="p-title" style="font-size:15px; display:block; font-weight:600;">Выберите трек</b>
                <span id="p-artist" style="color:#7a7a7a; font-size:13px;"></span>
            </div>
            <i data-lucide="heart" id="like-player" size="20" class="like-btn" style="margin-left:20px;" onclick="toggleLike()"></i>
        </div>

        <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
            <div style="display:flex; align-items:center; gap:20px;">
                <div class="p-btn" onclick="prevTrack()"><i data-lucide="skip-back" fill="white" size="18" style="transform: scale(0.9);"></i></div>
                <div class="p-btn" style="background:white; color:black;" onclick="togglePlay()">
                    <i id="main-play-btn" data-lucide="play" fill="black" size="22" style="margin-left:2px; transform: scale(0.9);"></i>
                </div>
                <div class="p-btn" onclick="nextTrack()"><i data-lucide="skip-forward" fill="white" size="18" style="transform: scale(0.9);"></i></div>
            </div>
            <div style="display:flex; align-items:center; gap:12px; width:100%; max-width:550px;">
                <span id="c-time" style="font-size:11px; color:#7a7a7a; width:35px;">0:00</span>
                <div class="bar-bg" onclick="seek(event)">
                    <div id="p-fill" class="bar-fill"></div>
                </div>
                <span id="d-time" style="font-size:11px; color:#7a7a7a; width:35px;">0:00</span>
            </div>
        </div>

        <div style="display:flex; justify-content:flex-end; align-items:center;">
            <div style="display:flex; align-items:center; gap:12px;" onwheel="handleVolumeWheel(event)">
                <i data-lucide="volume-2" size="18" color="#7a7a7a"></i>
                <div class="vol-slider" id="vol-slider" onmousedown="startVolDrag(event)">
                    <div id="v-fill" class="vol-fill" style="width:70%;"></div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
        window.albumTracks = [
            {title:"Disease", url:"https://s3.k-connect.ru/static/music/1475/5954/1770656682_Lady_Gaga_-_Disease.mp3", time:"3:50"},
            {title:"Abracadabra", url:"https://s3.k-connect.ru/static/music/1475/5955/1770656744_Lady_Gaga_-_Abracadabra.mp3", time:"3:43"},
            {title:"Garden Of Eden", url:"https://s3.k-connect.ru/static/music/1475/5956/1770656858_Lady_Gaga_-_Garden_Of_Eden.mp3", time:"3:59"},
            {title:"Perfect Celebrity", url:"https://s3.k-connect.ru/static/music/1475/5957/1770656859_Lady_Gaga_-_Perfect_Celebrity.mp3", time:"3:49"},
            {title:"Can't Stop the High", url:"https://s3.k-connect.ru/static/music/1475/5958/1770656859_Lady_Gaga_-_Can_t_Stop_the_High.mp3", time:"3:32"},
            {title:"Vanish Into You", url:"https://s3.k-connect.ru/static/music/1475/5959/1770656860_Lady_Gaga_-_Vanish_Into_You.mp3", time:"4:04"},
            {title:"Killah", url:"https://s3.k-connect.ru/static/music/1475/5960/1770656860_Lady_Gaga_-_Killah.mp3", time:"3:30"},
            {title:"Zombieboy", url:"https://s3.k-connect.ru/static/music/1475/5961/1770656861_Lady_Gaga_-_Zombieboy.mp3", time:"3:33"},
            {title:"The Dead Dance", url:"https://s3.k-connect.ru/static/music/1475/5962/1770656861_Lady_Gaga_-_The_Dead_Dance.mp3", time:"3:47"},
            {title:"LoveDrug", url:"https://s3.k-connect.ru/static/music/1475/5963/1770656862_Lady_Gaga_-_LoveDrug.mp3", time:"3:13"},
            {title:"How Bad Do U Want Me", url:"https://s3.k-connect.ru/static/music/1475/5964/1770656932_Lady_Gaga_-_How_Bad_Do_U_Want_Me.mp3", time:"3:58"},
            {title:"Don't Call Tonight", url:"https://s3.k-connect.ru/static/music/1475/5965/1770656932_Lady_Gaga_-_Don_t_Call_Tonight.mp3", time:"3:45"},
            {title:"Kill For Love", url:"https://s3.k-connect.ru/static/music/1475/5966/1770656933_Lady_Gaga_-_Kill_For_Love.mp3", time:"3:38"},
            {title:"Shadow Of A Man", url:"https://s3.k-connect.ru/static/music/1475/5967/1770656933_Lady_Gaga_-_Shadow_Of_A_Man.mp3", time:"3:19"},
            {title:"The Beast", url:"https://s3.k-connect.ru/static/music/1475/5968/1770656934_Lady_Gaga_-_The_Beast.mp3", time:"3:54"},
            {title:"Blade Of Grass", url:"https://s3.k-connect.ru/static/music/1475/5969/1770656934_Lady_Gaga_-_Blade_Of_Grass.mp3", time:"4:17"},
            {title:"Die With A Smile", url:"https://s3.k-connect.ru/static/music/1475/5970/1770656935_Lady_Gaga_-_Die_With_A_Smile.mp3", time:"4:11"}
        ];
        
        let audio = new Audio();
        let currentTracks = [];
        let currentIdx = -1;
        let isLiked = false;
        let isVolDragging = false;
        const albumCover = 'https://s3.k-connect.ru/static/music/1475/5955/1770656744_cover.jpeg';
        window.pinnedAlbum = null;
        
        window.audio = audio;
        window.currentTracks = currentTracks;
        window.currentIdx = currentIdx;

        // ========== МОЙ VIBE ==========
        window.isVibePlaying = false;
        window.vibeTracks = [];

        window.toggleVibePlay = function() {
            if (!window.isVibePlaying) {
                // Первый запуск или после остановки
                if (!window.vibeTracks.length) {
                    window.vibeTracks = [...window.albumTracks];
                }
                
                // Перемешиваем
                const shuffled = [...window.vibeTracks];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                // ОЧЕРЕДЬ ПУСТАЯ - НЕ ПОКАЗЫВАЕМ ТРЕКИ
                window.currentTracks = [];
                window.currentIdx = -1;
                renderQueue();
                
                // Запускаем первый трек
                setTimeout(() => {
                    window.playTrack(0, shuffled);
                    window.isVibePlaying = true;
                    updateVibeButton();
                }, 50);
            } else {
                // Повторное нажатие - ставим на паузу
                window.togglePlay();
                window.isVibePlaying = !audio.paused;
                updateVibeButton();
            }
        };

        function updateVibeButton() {
            const vibeIcon = document.getElementById('vibePlayIcon');
            if (vibeIcon) {
                if (window.isVibePlaying && !audio.paused) {
                    vibeIcon.setAttribute('data-lucide', 'pause');
                } else {
                    vibeIcon.setAttribute('data-lucide', 'play');
                }
                lucide.createIcons();
            }
        }

        // Следим за состоянием плеера для кнопки Vibe
        audio.addEventListener('play', function() {
            if (window.currentTracks !== window.albumTracks) {
                window.isVibePlaying = true;
                updateVibeButton();
            }
        });

        audio.addEventListener('pause', function() {
            if (window.currentTracks !== window.albumTracks) {
                window.isVibePlaying = false;
                updateVibeButton();
            }
        });

        // ========== ЗАГРУЗКА КОНТЕНТА ==========
        async function loadContent() {
            let hash = location.hash.replace('#', '') || 'home';
            try {
                const res = await fetch(`./pages/${hash}.html`);
                let html = await res.text();
                
                document.getElementById('content-area').innerHTML = html;
                
                const scripts = document.getElementById('content-area').getElementsByTagName('script');
                for (let script of scripts) {
                    eval(script.innerHTML);
                }
                
                lucide.createIcons();
                
                if (hash === 'home') {
                    renderPinnedInSide();
                    if (window.renderPinnedAlbum) {
                        setTimeout(window.renderPinnedAlbum, 50);
                    }
                }
            } catch {
                location.hash = '#home';
            }
        }

        // ========== ПЛЕЕР ==========
        window.playTrack = function(idx, trackList) {
            if (!trackList?.length) return;
            window.currentTracks = trackList;
            window.currentIdx = idx;
            const track = window.currentTracks[window.currentIdx];
            window.audio.src = track.url;
            window.audio.play();
            updateUI(track);
            renderQueue();
            
            setTimeout(() => {
                if (location.hash === '#mayhem' && window.renderMayhemTracks) {
                    window.renderMayhemTracks();
                    window.updateAlbumPlayButton?.();
                }
            }, 50);
        };

        function updateUI(track) {
            document.getElementById('p-title').innerText = track.title;
            document.getElementById('p-artist').innerText = 'Lady Gaga';
            document.getElementById('p-img').src = albumCover;
            document.getElementById('p-img').style.display = 'block';
            
            document.getElementById('side-cover').src = albumCover;
            document.getElementById('side-cover').style.display = 'block';
            document.getElementById('side-title').innerText = track.title;
            document.getElementById('side-artist').innerText = 'Lady Gaga';
            
            const icon = audio.paused ? 'play' : 'pause';
            document.getElementById('main-play-btn').setAttribute('data-lucide', icon);
            
            isLiked = false;
            document.querySelectorAll('.like-btn').forEach(el => {
                el.classList.remove('active');
                el.setAttribute('fill', 'none');
                el.setAttribute('color', '#b3b3b3');
            });
            
            lucide.createIcons();
        }

        window.togglePlay = function() {
            if (!audio.src) return;
            audio.paused ? audio.play() : audio.pause();
            if (window.currentTracks[window.currentIdx]) updateUI(window.currentTracks[window.currentIdx]);
            
            setTimeout(() => {
                if (location.hash === '#mayhem' && window.renderMayhemTracks) {
                    window.renderMayhemTracks();
                    window.updateAlbumPlayButton?.();
                }
            }, 50);
        };

        window.nextTrack = function() {
            if (window.currentIdx < window.currentTracks.length - 1) {
                window.playTrack(window.currentIdx + 1, window.currentTracks);
            }
        };

        window.prevTrack = function() {
            if (window.currentIdx > 0) {
                window.playTrack(window.currentIdx - 1, window.currentTracks);
            }
        };

        // ========== ОЧЕРЕДЬ ==========
        function renderQueue() {
            const queueList = document.getElementById('queue-list');
            if (!queueList) return;
            
            if (!window.currentTracks || !window.currentTracks.length) {
                queueList.innerHTML = '<p style="color:#7a7a7a; padding:10px;">Очередь пуста</p>';
                return;
            }
            
            const queueTracks = window.currentTracks.slice(window.currentIdx);
            
            queueList.innerHTML = queueTracks.map((t, i) => {
                const isPlaying = i === 0;
                return `
                    <div class="queue-item ${isPlaying ? 'playing' : ''}" onclick="window.playTrack(${window.currentIdx + i}, window.currentTracks)">
                        <img src="${albumCover}" style="width:44px; height:44px; border-radius:4px;">
                        <div style="flex:1;">
                            <b style="font-size:13px; ${isPlaying ? 'color: #CC6B26;' : ''}">${t.title}</b>
                            <br><small style="color:#7a7a7a;">Lady Gaga</small>
                        </div>
                        <span style="color:#7a7a7a; font-size:12px;">${t.time}</span>
                    </div>
                `;
            }).join('');
        }

        // ========== ВРЕМЯ ==========
        audio.ontimeupdate = function() {
            if (audio.duration) {
                const pct = (audio.currentTime / audio.duration) * 100 || 0;
                document.getElementById('p-fill').style.width = pct + '%';
                document.getElementById('c-time').innerText = formatTime(audio.currentTime);
                document.getElementById('d-time').innerText = formatTime(audio.duration);
            }
        };

        function formatTime(s) {
            if (!s) return '0:00';
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        window.seek = function(e) {
            if (!audio.duration) return;
            const rect = e.currentTarget.getBoundingClientRect();
            audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
        };

        // ========== ГРОМКОСТЬ ==========
        window.startVolDrag = function(e) {
            isVolDragging = true;
            updateVolumeFromEvent(e);
        };

        function updateVolumeFromEvent(e) {
            const rect = document.getElementById('vol-slider').getBoundingClientRect();
            let pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            audio.volume = pct;
            document.getElementById('v-fill').style.width = (pct * 100) + '%';
        }

        window.handleVolumeWheel = function(e) {
            e.preventDefault();
            audio.volume = Math.max(0, Math.min(1, audio.volume + (e.deltaY < 0 ? 0.05 : -0.05)));
            document.getElementById('v-fill').style.width = (audio.volume * 100) + '%';
        };

        window.addEventListener('mousemove', (e) => { if (isVolDragging) updateVolumeFromEvent(e); });
        window.addEventListener('mouseup', () => { isVolDragging = false; });

        // ========== ЛАЙК ==========
        window.toggleLike = function() {
            if (!window.currentTracks.length) return;
            isLiked = !isLiked;
            document.querySelectorAll('.like-btn').forEach(el => {
                el.classList.toggle('active', isLiked);
                if (isLiked) {
                    el.setAttribute('fill', '#CC6B26');
                    el.setAttribute('color', '#CC6B26');
                } else {
                    el.setAttribute('fill', 'none');
                    el.setAttribute('color', '#b3b3b3');
                }
            });
            lucide.createIcons();
        };

        // ========== ЛЕВАЯ ПАНЕЛЬ ==========
        window.scrollFilters = function(val) {
            document.getElementById('filterScroll').scrollLeft += val;
        };

        window.filterSide = function(type, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderSide(type);
        };

        function renderSide(filter) {
            const data = [
                { name: "Lady Gaga", sub: "Исполнитель", type: "artist" },
                { name: "Mayhem", sub: "Альбом • 2025", type: "album" }
            ];
            document.getElementById('filtered-content').innerHTML = data
                .filter(item => filter === 'all' || item.type === filter)
                .map(item => `
                    <div class="side-item" onclick="location.hash='#${item.type === 'album' ? 'mayhem' : ''}'">
                        <img src="${albumCover}" style="width:52px; height:52px; border-radius:4px;">
                        <div><b>${item.name}</b><br><small style="color:#7a7a7a;">${item.sub}</small></div>
                    </div>
                `).join('');
            
            renderPinnedInSide();
        }

        // ========== ЗАКРЕПЛЕННЫЙ АЛЬБОМ ==========
        function renderPinnedInSide() {
            const container = document.getElementById('pinned-side-container');
            if (!container) return;
            
            if (window.pinnedAlbum) {
                container.innerHTML = `
                    <h3 style="font-size:14px; font-weight:700; margin:20px 0 15px; color:#7a7a7a; text-transform:uppercase;">Закреплено</h3>
                    <div class="side-item" onclick="location.hash='#mayhem'">
                        <img src="${window.pinnedAlbum.cover}" style="width:52px; height:52px; border-radius:4px;">
                        <div><b>${window.pinnedAlbum.name}</b><br><small style="color:#7a7a7a;">${window.pinnedAlbum.sub}</small></div>
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }
        }

        window.renderPinnedInSide = renderPinnedInSide;

        // ========== ОБРАБОТЧИК КОНЦА ТРЕКА ==========
        audio.onended = function() {
            if (window.currentIdx < window.currentTracks.length - 1) {
                window.playTrack(window.currentIdx + 1, window.currentTracks);
            }
            renderQueue();
            
            setTimeout(() => {
                if (location.hash === '#mayhem' && window.renderMayhemTracks) {
                    window.renderMayhemTracks();
                    window.updateAlbumPlayButton?.();
                }
            }, 100);
        };

        // ========== СТАРТ ==========
        window.addEventListener('hashchange', loadContent);
        window.onload = () => {
            loadContent();
            renderSide('all');
            lucide.createIcons();
            audio.volume = 0.7;
        };
    </script>
</body>
</html>
